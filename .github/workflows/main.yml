name: update-friends-posts
on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 0,6,12,18,21 * * *"
  workflow_dispatch:

env:
  SIMPLE_MODE: false
  STORAGE_TYPE: ${{ secrets.STORAGE_TYPE }}
  PROXY: ${{ secrets.PROXY }}
  APPID: ${{ secrets.APPID }}
  APPKEY: ${{ secrets.APPKEY }}
  MYSQL_USERNAME: ${{ secrets.MYSQL_USERNAME }}
  MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
  MYSQL_IP: ${{ secrets.MYSQL_IP }}
  MYSQL_PORT: ${{ secrets.MYSQL_PORT }}
  MYSQL_DB: ${{ secrets.MYSQL_DB }}
  GITHUB_NAME: ${{ secrets.GH_NAME }}
  GITHUB_EMAIL: ${{ secrets.GH_EMAIL }}
  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}  # 仅用于 git push
  MONGODB_URI: ${{ secrets.MONGODB_URI }}
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.8"

      - name: Install requirements
        working-directory: ./hexo_circle_of_friends
        run: pip install -r requirements.txt

      - name: Set env
        run: |
          echo "BASE_PATH=$(pwd)" >> $GITHUB_ENV
          echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV

      # leancloud
      - name: leancloud Update posts
        if: ${{ env.STORAGE_TYPE == 'leancloud' }}
        env:
          APPID: ${{ secrets.APPID }}
          APPKEY: ${{ secrets.APPKEY }}
          LINK: ${{ secrets.LINK }}
          PROXY: ${{ secrets.PROXY }}
        working-directory: ./hexo_circle_of_friends
        run: python run.py

      # mysql
      - name: mysql Update posts
        if: ${{ env.STORAGE_TYPE == 'mysql' }}
        env:
          MYSQL_USERNAME: ${{ secrets.MYSQL_USERNAME }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_IP: ${{ secrets.MYSQL_IP }}
          MYSQL_DB: ${{ secrets.MYSQL_DB }}
        working-directory: ./hexo_circle_of_friends
        run: python run.py

      # sqlite
      - name: sqlite Update posts
        if: ${{ env.STORAGE_TYPE == 'sqlite' || env.SIMPLE_MODE == 'true' }}
        env:
          PYTHONPATH: ${{ env.PYTHONPATH }}
          SQLITE_DB: ${{ secrets.SQLITE_DB }}
        run: python ./hexo_circle_of_friends/run.py

      - name: Push sqlite data
        if: ${{ env.STORAGE_TYPE == 'sqlite' }}
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update data.db"
          file_pattern: data.db
          commit_user_name: ${{ secrets.GH_NAME }}
          commit_user_email: ${{ secrets.GH_NAME }} <${{ secrets.GH_EMAIL }}>
          push_options: --force
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}  # git push 必须用 PAT

      # mongodb
      - name: mongodb Update posts
        if: ${{ env.STORAGE_TYPE == 'mongodb' }}
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        working-directory: ./hexo_circle_of_friends
        run: python run.py

      # 极简模式：生成 + 发布
      - name: simple mode transform
        if: ${{ env.SIMPLE_MODE == 'true' }}
        run: python ./hexo_circle_of_friends/utils/simple_mode_transform_json.py

      - name: Release data.json (overwrite latest)
        if: ${{ env.SIMPLE_MODE == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          files: data.json
          overwrite: true
          # 使用默认 GITHUB_TOKEN，无需 secrets

      - name: keep alive
        uses: gautamkrishnar/keepalive-workflow@v2
